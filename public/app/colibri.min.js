!function(){angular.module("AlertModule",[]),angular.module("NavigationModule",[]),angular.module("LoginModule",[]),angular.module("EventModule",[]),angular.module("TerminalModule",[]),angular.module("UserModule",[]);var e=angular.module("myAPP",["ngRoute","ngStorage","720kb.tooltips","AlertModule","LoginModule","EventModule","TerminalModule","NavigationModule","UserModule"]);e.constant("config",{getEventURL:"/events/getEvents",addEventURL:"/events/addEvent",editEventURL:"/events/editEvent",deleteEventURL:"/events/deleteEvent",getTerminalsURL:"/terminals/getTerminals",getTerminalURL:"/terminals/getTerminal",editCranesURL:"/cranes/editEventCranes",loginUserURL:"/users/login",changePasswordURL:"/users/password"}),e.constant("errors",{connectionError:{userMessage:"Connection error, please contact Colibri support",message:"Connection error, please contact Colibri support",type:"ERROR",code:"CONNECTION_ERROR"}}),e.constant("tableProp",{tableDayHeight:84,tableDayHeightNoBorder:83,tableTopHeaderHeight:29,tableLeftHeaderWidth:100,tableTotalWidth:1099,cellHourHeight:3.5,hoursInDay:24,minutesHour:60,totalPixelLength:999}),e.config(["$logProvider",function(e){e.debugEnabled(!0)}]),e.config(["$httpProvider",function(e){e.interceptors.push(["$q","$location","$log","$sessionStorage","alertService",function(e,t,n,r,o){return{request:function(e){return n.debug("Intersected"),e.headers=e.headers||{},e.headers.Accept="application/json",r.userToken&&(e.headers.Authorization="Bearer "+r.userToken),n.debug("Config Headers After:"+JSON.stringify(e.headers)),e},responseError:function(n){return 401===n.status||403===n.status?t.path("/"):n.code&&o.pushMessage(n),e.reject(n)}}}])}]),e.factory("_",[function(){return window._}]),e.config(["$routeProvider",function(e){e.when("/events/:terminalId",{templateUrl:"app/events/events.html",controller:"EventController"}).when("/terminals",{templateUrl:"app/terminals/terminals.html",controller:"TerminalController"}).when("/user",{templateUrl:"app/user/user.html",controller:"UserController"}).when("/",{templateUrl:"app/login/login.html",controller:"LoginController"}).otherwise({redirectTo:"/"})}])}(),function(){var e=angular.module("LoginModule");e.controller("LoginController",["$http","$log","$scope","$routeParams","config","$rootScope","_","$location","$sessionStorage",function(e,t,n,r,o,a,i,s,u){n.loginUser="",n.showPage=!1,n.formError="",u.userToken&&""!=u.userToken?s.path("/terminals"):n.showPage=!0,n.login=function(r){t.debug("Login with:"+JSON.stringify(r));var a={userEmail:r.email,userPassword:r.password};e.post(o.loginUserURL,a).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.userToken&&""!=e.userToken?(u.userToken=e.userToken,u.userEmail=e.userEmail,s.path("/terminals")):n.formError="Invalid email or password"}).error(function(){t.debug("Error")})}}])}(),function(){var e=angular.module("EventModule");e.controller("EventController",["$http","$log","$scope","$routeParams","config","alertService","_","eventService","terminalService",function(e,t,n,r,o,a,i,s,u){function l(){s.updateEvents(c).then(function(e){n.events=e},function(e){a.pushMessage(e)})}function d(){u.getTerminal(c).then(function(e){n.terminal=e,l(),n.calendarLoaded=!0},function(e){a.pushMessage(e)})}var c=r.terminalId;t.debug("TERMINAL ID:"+c),n.events=[],n.terminal="",n.hours=["1","2","3","4","5","6","7","8","9","10","11","12"],n.days=[{dayId:1,dayName:"Monday"},{dayId:2,dayName:"Tuesday"},{dayId:3,dayName:"Wednesday"},{dayId:4,dayName:"Thursday"},{dayId:5,dayName:"Friday"},{dayId:6,dayName:"Saturday"},{dayId:7,dayName:"Sunday"}],n.editable=!1,n.newEvent="",n.cranesList=[],n.calendarLoaded=!1,d(),n.addNewEvent=function(e){if(t.debug("New Event:"+JSON.stringify(e)),n.eventForm.$invalid)return t.debug("Invalid Form"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,berthId:e.berthId,terminalId:c};s.addNewEvent(r).then(function(e){n.events=e,$("#eventModal").modal("hide"),n.newEvent=""},function(e){a.pushMessage(e)})},n.changeButton=function(){t.debug("Changing Form button"),n.editable=!1,n.eventForm.$setPristine(),n.newEvent=""},n.editEvent=function(e){if(t.debug("Edit Event:"+JSON.stringify(e)),n.eventForm.$invalid)return t.debug("Form is Invalid"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,eventId:e.eventId,berthId:e.berthId,terminalId:c};s.editEvent(r).then(function(e){n.events=e},function(e){a.pushMessage(e)}),n.eventChange=n.eventChange?!1:!0,n.newEvent={}},n.editEventModal=function(e){t.debug("Event to edit Modal:"+JSON.stringify(e)),n.newEvent=angular.copy(e),n.editable=!0},n.deleteEvent=function(e){t.debug("Delete Event:"+JSON.stringify(e)),s.deleteEvent(e.eventId).then(function(e){n.events=e},function(e){a.pushMessage(e)})},n.updateEvents=function(){t.debug("Update Events"),l()},n.moveEvent=function(e){t.debug("Moved Event: "+JSON.stringify(e));var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,eventId:e.eventId,berthId:e.berthId};s.editEvent(r).then(function(e){n.events=e},function(e){a.pushMessage(e)})},n.editCranesModal=function(e){t.debug("Edit Cranes Modal:"+JSON.stringify(e));var r=[],o=n.terminal.cranes,a=e.eventCranes;n.newEvent=e;for(var s=[],u=0;u<a.length;u++){var l=a[u];r.push(l.craneId)}t.debug("Terminal Cranes:"+JSON.stringify(o));for(var d=0;d<o.length;d++){var c=o[d],v=!1;i.contains(r,c.craneId)&&(v=!0);var g={craneId:c.craneId,craneName:c.craneName,value:v};s.push(g)}t.debug("Crane Final List:"+JSON.stringify(s)),n.cranesList=s},n.editCranes=function(e){t.debug("Edit Cranes:"+JSON.stringify(e));for(var r=n.newEvent,o={eventId:r.eventId},i=[],u=0;u<e.length;u++){var l=e[u];l.value&&i.push({craneId:l.craneId})}o.cranes=i,t.debug("JSON to Send:"+JSON.stringify(o)),s.editCranes(o).then(function(e){n.events=e,$("#craneModal").modal("hide")},function(e){a.pushMessage(e)})}}])}(),function(){var e=angular.module("EventModule");e.directive("tableGen",["$log",function(e){return{restrict:"E",templateUrl:"./app/events/table.html",scope:{terminal:"=terminalInfo",hours:"=hours"},controller:["$scope","tableProp",function(t,n){function r(t){if(t)for(var r=t.totalLength,o=0;o<t.berths.length;o++){var a=t.berths[o];a.pixelLength=n.totalPixelLength/r*a.berthLength}e.debug("New Terminal Data:"+JSON.stringify(t))}t.$watch("terminal",function(){console.debug("Terminal 3:"+JSON.stringify(t.terminal)),r(t.terminal)})}]}}]),e.directive("event",["$log","$document",function(e,t){return{restrict:"E",templateUrl:"./app/events/event.html",scope:{event:"=event",terminal:"=terminalInfo",eventChange:"=eventChange",moveEvent:"&moveEvent",editEventModal:"&editEventModal",deleteEvent:"&deleteEvent",editCranesModal:"&editCranesModal"},controller:["$scope","tableProp",function(t,n){function r(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}t.eventToCSS=function(t,r){e.debug("Main Event:"+JSON.stringify(t)),e.debug("Terminal:"+JSON.stringify(r));var o=r.totalLength;t.eventStart=t.eventStart+r.mainBerths[t.berthId].sumLength,e.debug("Modified Event:"+JSON.stringify(t));var a=t.eventArrivingTime.split(":"),i=parseInt(a[0],10),s=parseInt(a[1],10),u=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*i+n.tableTopHeaderHeight,l=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*(i+t.eventDuration)+n.tableTopHeaderHeight,d=s/n.minutesHour*n.cellHourHeight;u+=d,l+=d,e.debug("arrivingTimeSec:"+s),e.debug("Add to Top:"+d);var c=t.eventStart*(n.tableTotalWidth-n.tableLeftHeaderWidth)/o+n.tableLeftHeaderWidth,v=(t.eventStart+t.eventLength)*(n.tableTotalWidth-n.tableLeftHeaderWidth)/o+n.tableLeftHeaderWidth,g={top:u,left:c,width:v-c,height:l-u};return g},t.CSSToEvent=function(t,o){var a=t.left,i=t.top,s=o.totalLength,u=(a-n.tableLeftHeaderWidth)*(s/(n.tableTotalWidth-n.tableLeftHeaderWidth)),l=Math.ceil((i-n.tableTopHeaderHeight)/n.tableDayHeight),d=(i-n.tableTopHeaderHeight)%n.tableDayHeight*(n.hoursInDay/n.tableDayHeightNoBorder),c=parseInt(100*(d-parseInt(d)));e.debug("Event Arriving Time:"+c);var v=c/100*n.minutesHour;e.debug("Event Arriving Minutes:"+v);var g=r(parseInt(d,10),2)+":"+r(parseInt(v,10),2),f="";for(var h in o.mainBerths){var m=o.mainBerths[h].sumLength;u>=m&&(f=h)}e.debug("Berth Id: "+f),u-=o.mainBerths[f].sumLength,e.debug("Event Start After: "+u);var p={eventStart:u,eventDay:l,eventArrivingTime:g,berthId:f};return p}}],link:function(n,r){function o(e){l=e.pageY-s,u=e.pageX-i,r.css({top:l+"px",left:u+"px"})}function a(){t.off("mousemove",o),t.off("mouseup",a);var r={left:u,top:l},i=n.CSSToEvent(r,n.terminal);n.event.eventDay=i.eventDay,n.event.eventStart=parseInt(i.eventStart),n.event.eventArrivingTime=i.eventArrivingTime,n.event.berthId=i.berthId,n.moveEvent(n.event),n.$apply(),e.debug("New scope event:"+JSON.stringify(n.event))}var i=0,s=0,u=0,l=0;n.$watch("eventChange",function(){e.debug("Event Change:"+JSON.stringify(n.event));var t=angular.copy(n.event),o=n.eventToCSS(t,n.terminal);e.debug("AFTER CSS SCOPE EVENT:"+JSON.stringify(n.event)),r.css({width:o.width,height:o.height,top:o.top,left:o.left}),i=o.left,s=o.top,u=o.left,l=o.top}),r.on("mousedown",function(e){"resizer"!=e.target.className&&(e.preventDefault(),s=e.pageY-l,i=e.pageX-u,t.on("mousemove",o),t.on("mouseup",a))})}}}]),e.directive("resizer",["$document","$log",function(e,t){return{restrict:"A",link:function(n,r){function o(e){var n=e.pageY-u+s;t.debug("New Height:"+n)}function a(){e.unbind("mousemove",o),e.unbind("mouseup",a)}var i=parseInt($(r).parent().css("top"),10),s=parseInt($(r).parent().css("height"),10),u=i+s;r.on("mousedown",function(t){t.preventDefault(),u=t.pageY-u,e.on("mousemove",o),e.on("mouseup",a)})}}}])}(),function(){var e=angular.module("EventModule");e.service("eventService",["$http","$log","config","_","alertService","$q","errors",function(e,t,n,r,o,a,i){function s(e){u.forEach(function(t,n){t.eventId==e.eventId&&(u[n]=e)})}var u=[];this.updateEvents=function(r){var o=a.defer();return e.get(n.getEventURL+"/"+r).success(function(e){t.debug("Received Events:"+JSON.stringify(e)),e.message?(t.debug("Error getting events"),o.reject(e)):(u=e,o.resolve(u))}).error(function(){o.reject(i.connectionError)}),o.promise},this.addNewEvent=function(r){var o=a.defer(),s=angular.copy(r);return e.post(n.addEventURL,s).success(function(e){t.debug("Add Event Received Data:"+JSON.stringify(e)),e.message?o.reject(e):(u.push(e),o.resolve(u))}).error(function(){o.reject(i.connectionError)}),o.promise},this.editEvent=function(r){var o=a.defer(),l=angular.copy(r);return e.post(n.editEventURL,l).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.message?o.reject(e):(s(e),o.resolve(u))}).error(function(){o.reject(i.connectionError)}),o.promise},this.deleteEvent=function(r){var o=a.defer();return e.post(n.deleteEventURL,{eventId:r}).success(function(e){if(t.debug("Received Delete Data:"+JSON.stringify(e)),e.message)o.reject(e);else{var n=-1;u.forEach(function(e,t){e.eventId==r&&(n=t)}),u.splice(n,1),o.resolve(u)}}).error(function(){o.reject(i.connectionError)}),o.promise},this.editCranes=function(r){var o=a.defer(),l={json:JSON.stringify(r)};return e.post(n.editCranesURL,l).success(function(e){t.debug("Received Edit Crane Data:"+JSON.stringify(e)),s(e),o.resolve(u)}).error(function(){o.reject(i.connectionError)}),o.promise}}])}(),function(){var e=angular.module("TerminalModule");e.controller("TerminalController",["$http","$log","$scope","$routeParams","config","alertService",function(e,t,n,r,o,a){function i(){e.get(o.getTerminalsURL).success(function(e){t.debug("Received Terminals:"+JSON.stringify(e)),e.type?a.pushMessage(e):n.terminals=e}).error(function(){a.pushMessage("Connexion Refused")})}n.terminals=[],i()}])}(),function(){var e=angular.module("TerminalModule");e.service("terminalService",["$http","$log","config","_","alertService","$q","errors",function(e,t,n,r,o,a,i){function s(e){for(var t={},n=0,r=0;r<e.length;r++){var o=e[r];o.berthStart&&(t[o.berthId]={sumLength:n,berthName:o.berthName,berthId:o.berthId}),n+=o.berthLength}return t}var u={};this.getTerminal=function(r){var o=a.defer();return e.get(n.getTerminalURL+"/"+r).success(function(e){t.debug("Terminal Info Received:"+JSON.stringify(e)),e.type?o.reject(e):(u=e,e.berths?(u.mainBerths=s(u.berths),o.resolve(u)):o.reject(i.connectionError))}).error(function(){o.reject(i.connectionError)}),o.promise}}])}(),function(){var e=angular.module("UserModule");e.controller("UserController",["$http","$log","$scope","$routeParams","config","alertService","$sessionStorage",function(e,t,n,r,o,a,i){n.newUser="",n.formError="",n.changePassword=function(r){if(t.debug("Change Password"),n.changePasswordForm.$invalid)return t.debug("Invalid Form"),void(n.changePasswordForm.showValidation=!0);if(r.newPassword!=r.confirmPassword)return void(n.formError="Confirm Password is not the same as new Password");var s={userEmail:i.userEmail,oldPassword:r.oldPassword,newPassword:r.newPassword};e.post(o.changePasswordURL,s).success(function(e){e.code?a.pushMessage(e):a.pushSuccessMessage("Password changed")}).fail(function(){a.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("AlertModule");e.directive("alertsDisplay",["$log",function(e){return{restrict:"E",templateUrl:"./app/shared/alerts/alerts.html",replace:!0,controller:["$scope",function(t){t.errorMessage="",t.showError=!1,t.showSuccess=!1,t.successMessage="",t.$on("AlertEvent",function(n,r){e.debug("AlertEvent Call:"+r),t.showError=!1,t.showError=!0,t.errorMessage=r}),t.$on("SuccessMessage",function(n,r){e.debug("Success Message Call:"+r),t.showSuccess=!0,t.successMessage=r})}]}}])}(),function(){var e=angular.module("AlertModule");e.service("alertService",["$log","$rootScope",function(e,t){this.pushMessage=function(n){e.debug("Alert Message:"+n),e.error("Error:"+JSON.stringify(n)),n.message?t.$broadcast("AlertEvent",n.message):t.$broadcast("AlertEvent",n)},this.pushSuccessMessage=function(n){e.debug("Success Message:"+n),t.$broadcast("SuccessMessage",n)}}])}(),function(){var e=angular.module("NavigationModule");e.directive("navigationBar",["$log","$document","$sessionStorage","$location",function(e,t,n,r){return{restrict:"E",templateUrl:"./app/shared/navigation/navigation.html",replace:!0,controller:["$scope",function(t){t.logout=function(){e.debug("Logout"),delete n.userToken,r.path("/")}}]}}])}();