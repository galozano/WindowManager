!function(){angular.module("AlertModule",[]),angular.module("NavigationModule",[]),angular.module("LoginModule",[]),angular.module("EventModule",[]),angular.module("TerminalModule",[]),angular.module("UserModule",[]);var e=angular.module("myAPP",["ngRoute","ngStorage","720kb.tooltips","AlertModule","LoginModule","EventModule","TerminalModule","NavigationModule","UserModule"]);e.constant("config",{getEventURL:"/events/getEvents",addEventURL:"/events/addEvent",editEventURL:"/events/editEvent",deleteEventURL:"/events/deleteEvent",getTerminalsURL:"/terminals/getTerminals",getTerminalURL:"/terminals/getTerminal",editCranesURL:"/cranes/editEventCranes",loginUserURL:"/users/login",changePasswordURL:"/users/password"}),e.constant("errors",{connectionError:{userMessage:"Connection error, please contact Colibri support",message:"Connection error, please contact Colibri support",type:"ERROR",code:"CONNECTION_ERROR"}}),e.constant("tableProp",{tableDayHeight:84,tableDayHeightNoBorder:83,tableTopHeaderHeight:29,tableLeftHeaderWidth:100,tableTotalWidth:1099,cellHourHeight:3.5,hoursInDay:24,minutesHour:60}),e.config(["$logProvider",function(e){e.debugEnabled(!0)}]),e.config(["$httpProvider",function(e){e.interceptors.push(["$q","$location","$log","$sessionStorage","alertService",function(e,t,n,r,a){return{request:function(e){return n.debug("Intersected"),e.headers=e.headers||{},e.headers.Accept="application/json",r.userToken&&(e.headers.Authorization="Bearer "+r.userToken),n.debug("Config Headers After:"+JSON.stringify(e.headers)),e},responseError:function(n){return 401===n.status||403===n.status?t.path("/"):n.code&&a.pushMessage(n),e.reject(n)}}}])}]),e.factory("_",[function(){return window._}]),e.config(["$routeProvider",function(e){e.when("/events/:terminalId",{templateUrl:"app/events/events.html",controller:"EventController"}).when("/terminals",{templateUrl:"app/terminals/terminals.html",controller:"TerminalController"}).when("/user",{templateUrl:"app/user/user.html",controller:"UserController"}).when("/",{templateUrl:"app/login/login.html",controller:"LoginController"}).otherwise({redirectTo:"/"})}])}(),function(){var e=angular.module("EventModule");e.controller("EventController",["$http","$log","$scope","$routeParams","config","alertService","_","eventService",function(e,t,n,r,a,o,i,s){function u(){s.updateEvents(g).then(function(e){n.events=e},function(e){o.pushMessage(e)})}function d(e){for(var r=new Object,a=0,o=0;o<e.length;o++){var i=e[o];i.berthStart&&(r[i.berthId]={sumLength:a,berthName:i.berthName,berthId:i.berthId}),a+=i.berthLength}n.terminal.mainBerths=r,t.debug("Modified Terminal:"+JSON.stringify(n.terminal))}function l(e){for(var n=e.totalLength,r=999,a=0;a<e.berths.length;a++){var o=e.berths[a];o.pixelLength=r/n*o.berthLength}t.debug("New Terminal Data:"+JSON.stringify(e))}function c(){e.get(a.getTerminalURL+"/"+g).success(function(e){t.debug("Terminal Info Received:"+JSON.stringify(e)),e.type?o.pushMessage(e):(l(e),n.terminal=e,e.berths?(d(e.berths),u(),n.calendarLoaded=!0):o.pushMessage("Unable to load events"))}).error(function(){o.pushMessage("Connection Error")})}function v(){c()}var g=r.terminalId;t.debug("TERMINAL ID:"+g),n.events=[],n.terminal="",n.hours=["1","2","3","4","5","6","7","8","9","10","11","12"],n.days=[{dayId:1,dayName:"Monday"},{dayId:2,dayName:"Tuesday"},{dayId:3,dayName:"Wednesday"},{dayId:4,dayName:"Thursday"},{dayId:5,dayName:"Friday"},{dayId:6,dayName:"Saturday"},{dayId:7,dayName:"Sunday"}],n.editable=!1,n.newEvent="",n.cranesList=[],n.calendarLoaded=!1,v(),n.addNewEvent=function(e){if(t.debug("New Event"),n.eventForm.$invalid)return t.debug("Invalid Form"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,berthId:e.berthId,terminalId:g};s.addNewEvent(r).then(function(e){n.events=e,$("#eventModal").modal("hide"),n.newEvent=""},function(e){o.pushMessage(e)})},n.changeButton=function(){t.debug("Changing Form button"),n.editable=!1,n.eventForm.$setPristine(),n.newEvent=""},n.editEvent=function(e){if(t.debug("Edit Event:"+JSON.stringify(e)),n.eventForm.$invalid)return t.debug("Form is Invalid"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,eventId:e.eventId,berthId:e.berthId,terminalId:g};s.editEvent(r).then(function(e){n.events=e},function(e){o.pushMessage(e)}),n.eventChange=n.eventChange?!1:!0,n.newEvent={}},n.editEventModal=function(e){t.debug("Event to edit Modal:"+JSON.stringify(e)),n.newEvent=angular.copy(e),n.editable=!0},n.deleteEvent=function(e){t.debug("Delete Event:"+JSON.stringify(e)),s.deleteEvent(e.eventId).then(function(e){n.events=e},function(e){o.pushMessage(e)})},n.updateEvents=function(){t.debug("Update Events"),u()},n.moveEvent=function(n){t.debug("Move Event"),t.debug("Moved Event: "+JSON.stringify(n));var r={eventName:n.eventName,eventArrivingTime:n.eventArrivingTime,eventDuration:n.eventDuration,eventStart:n.eventStart,eventLength:n.eventLength,eventDay:n.eventDay,eventId:n.eventId,berthId:n.berthId};e.post(a.editEventURL,r).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e))}).error(function(){o.pushMessage("Connection Error")})},n.editCranesModal=function(e){t.debug("Edit Cranes Modal:"+JSON.stringify(e));var r=[],a=n.terminal.cranes,o=e.eventCranes;n.newEvent=e;for(var s=[],u=0;u<o.length;u++){var d=o[u];r.push(d.craneId)}t.debug("Terminal Cranes:"+JSON.stringify(a));for(var l=0;l<a.length;l++){var c=a[l],v=!1;i.contains(r,c.craneId)&&(v=!0);var g={craneId:c.craneId,craneName:c.craneName,value:v};s.push(g)}t.debug("Crane Final List:"+JSON.stringify(s)),n.cranesList=s},n.editCranes=function(r){t.debug("Edit Cranes:"+JSON.stringify(r));for(var i=n.newEvent,s={eventId:i.eventId},d=[],l=0;l<r.length;l++){var c=r[l];c.value&&d.push({craneId:c.craneId})}s.cranes=d,t.debug("JSON to Send:"+JSON.stringify(s));var v={json:JSON.stringify(s)};e.post(a.editCranesURL,v).success(function(e){t.debug("Received Edit Crane Data:"+JSON.stringify(e)),$("#craneModal").modal("hide"),u()}).error(function(){o.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("EventModule");e.directive("tableGen",function(){return{restrict:"E",templateUrl:"./app/events/table.html",replace:!0}}),e.directive("event",["$log","$document",function(e,t){return{restrict:"E",templateUrl:"./app/events/event.html",replace:!0,transclude:!0,controller:["$scope","tableProp",function(t,n){function r(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}t.eventToCSS=function(t,r){e.debug("Main Event:"+JSON.stringify(t)),e.debug("Terminal:"+JSON.stringify(r));var a=r.totalLength;t.eventStart=t.eventStart+r.mainBerths[t.berthId].sumLength,e.debug("Modified Event:"+JSON.stringify(t));var o=t.eventArrivingTime.split(":"),i=parseInt(o[0],10),s=parseInt(o[1],10),u=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*i+n.tableTopHeaderHeight,d=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*(i+t.eventDuration)+n.tableTopHeaderHeight,l=s/n.minutesHour*n.cellHourHeight;u+=l,d+=l,e.debug("arrivingTimeSec:"+s),e.debug("Add to Top:"+l);var c=t.eventStart*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,v=(t.eventStart+t.eventLength)*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,g={top:u,left:c,width:v-c,height:d-u};return g},t.CSSToEvent=function(t,a){var o=t.left,i=t.top,s=a.totalLength,u=(o-n.tableLeftHeaderWidth)*(s/(n.tableTotalWidth-n.tableLeftHeaderWidth)),d=Math.ceil((i-n.tableTopHeaderHeight)/n.tableDayHeight),l=(i-n.tableTopHeaderHeight)%n.tableDayHeight*(n.hoursInDay/n.tableDayHeightNoBorder),c=parseInt(100*(l-parseInt(l)));e.debug("Event Arriving Time:"+c);var v=c/100*n.minutesHour;e.debug("Event Arriving Minutes:"+v);var g=r(parseInt(l,10),2)+":"+r(parseInt(v,10),2),f="";for(var h in a.mainBerths){var m=a.mainBerths[h].sumLength;u>=m&&(f=h)}e.debug("Berth Id: "+f),u-=a.mainBerths[f].sumLength,e.debug("Event Start After: "+u);var p={eventStart:u,eventDay:d,eventArrivingTime:g,berthId:f};return p}}],link:function(n,r){function a(e){d=e.pageY-s,u=e.pageX-i,r.css({top:d+"px",left:u+"px"})}function o(){t.off("mousemove",a),t.off("mouseup",o);var r={left:u,top:d},i=n.CSSToEvent(r,n.terminal);n.event.eventDay=i.eventDay,n.event.eventStart=parseInt(i.eventStart),n.event.eventArrivingTime=i.eventArrivingTime,n.event.berthId=i.berthId,n.moveEvent(n.event),n.$apply(),e.debug("New scope event:"+JSON.stringify(n.event))}var i=0,s=0,u=0,d=0;n.$watch("eventChange",function(){e.debug("Event Change:"+JSON.stringify(n.event));var t=angular.copy(n.event),a=n.eventToCSS(t,n.terminal);e.debug("AFTER CSS SCOPE EVENT:"+JSON.stringify(n.event)),r.css({width:a.width,height:a.height,top:a.top,left:a.left}),i=a.left,s=a.top,u=a.left,d=a.top}),r.on("mousedown",function(e){"resizer"!=e.target.className&&(e.preventDefault(),s=e.pageY-d,i=e.pageX-u,t.on("mousemove",a),t.on("mouseup",o))})}}}]),e.directive("resizer",["$document","$log",function(e,t){return{restrict:"A",link:function(n,r){function a(e){var n=e.pageY-u+s;t.debug("New Height:"+n)}function o(){e.unbind("mousemove",a),e.unbind("mouseup",o)}var i=parseInt($(r).parent().css("top"),10),s=parseInt($(r).parent().css("height"),10),u=i+s;r.on("mousedown",function(t){t.preventDefault(),u=t.pageY-u,e.on("mousemove",a),e.on("mouseup",o)})}}}])}(),function(){var e=angular.module("EventModule");e.service("eventService",["$http","$log","config","_","alertService","$q","errors",function(e,t,n,r,a,o,i){var s=[];this.updateEvents=function(r){var a=o.defer();return e.get(n.getEventURL+"/"+r).success(function(e){t.debug("Received Events:"+JSON.stringify(e)),e.message?(t.debug("Error getting events"),a.reject(e)):(s=e,a.resolve(s))}).error(function(){a.reject(i.connectionError)}),a.promise},this.addNewEvent=function(r){var a=o.defer(),u=angular.copy(r);return e.post(n.addEventURL,u).success(function(e){t.debug("Add Event Received Data:"+JSON.stringify(e)),e.message?a.reject(e):(s.push(e),a.resolve(s))}).error(function(){a.reject(i.connectionError)}),a.promise},this.editEvent=function(r){var a=o.defer(),u=angular.copy(r);return e.post(n.editEventURL,u).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.message?a.reject(e):(s.forEach(function(t,n){t.eventId==e.eventId&&(s[n]=e)}),a.resolve(s))}).error(function(){a.reject(i.connectionError)}),a.promise},this.deleteEvent=function(r){var a=o.defer();return e.post(n.deleteEventURL,{eventId:r}).success(function(e){if(t.debug("Received Delete Data:"+JSON.stringify(e)),e.message)a.reject(e);else{var n=-1;s.forEach(function(e,t){e.eventId==r&&(n=t)}),s.splice(n,1),a.resolve(s)}}).error(function(){a.reject(i.connectionError)}),a.promise}}])}(),function(){var e=angular.module("LoginModule");e.controller("LoginController",["$http","$log","$scope","$routeParams","config","$rootScope","_","$location","$sessionStorage",function(e,t,n,r,a,o,i,s,u){n.loginUser="",n.showPage=!1,n.formError="",u.userToken&&""!=u.userToken?s.path("/terminals"):n.showPage=!0,n.login=function(r){t.debug("Login with:"+JSON.stringify(r));var o={userEmail:r.email,userPassword:r.password};e.post(a.loginUserURL,o).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.userToken&&""!=e.userToken?(u.userToken=e.userToken,u.userEmail=e.userEmail,s.path("/terminals")):n.formError="Invalid email or password"}).error(function(){t.debug("Error")})}}])}(),function(){var e=angular.module("TerminalModule");e.controller("TerminalController",["$http","$log","$scope","$routeParams","config","alertService",function(e,t,n,r,a,o){function i(){e.get(a.getTerminalsURL).success(function(e){t.debug("Received Terminals:"+JSON.stringify(e)),e.type?o.pushMessage(e):n.terminals=e}).error(function(){o.pushMessage("Connexion Refused")})}n.terminals=[],i()}])}(),function(){var e=angular.module("UserModule");e.controller("UserController",["$http","$log","$scope","$routeParams","config","alertService","$sessionStorage",function(e,t,n,r,a,o,i){n.newUser="",n.formError="",n.changePassword=function(r){if(t.debug("Change Password"),n.changePasswordForm.$invalid)return t.debug("Invalid Form"),void(n.changePasswordForm.showValidation=!0);if(r.newPassword!=r.confirmPassword)return void(n.formError="Confirm Password is not the same as new Password");var s={userEmail:i.userEmail,oldPassword:r.oldPassword,newPassword:r.newPassword};e.post(a.changePasswordURL,s).success(function(e){e.code?o.pushMessage(e):o.pushSuccessMessage("Password changed")}).fail(function(){o.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("AlertModule");e.directive("alertsDisplay",["$log",function(e){return{restrict:"E",templateUrl:"./app/shared/alerts/alerts.html",replace:!0,controller:["$scope",function(t){t.errorMessage="",t.showError=!1,t.showSuccess=!1,t.successMessage="",t.$on("AlertEvent",function(n,r){e.debug("AlertEvent Call:"+r),t.showError=!1,t.showError=!0,t.errorMessage=r}),t.$on("SuccessMessage",function(n,r){e.debug("Success Message Call:"+r),t.showSuccess=!0,t.successMessage=r})}]}}])}(),function(){var e=angular.module("AlertModule");e.service("alertService",["$log","$rootScope",function(e,t){this.pushMessage=function(n){e.debug("Alert Message:"+n),e.error("Error:"+JSON.stringify(n)),n.message?t.$broadcast("AlertEvent",n.message):t.$broadcast("AlertEvent",n)},this.pushSuccessMessage=function(n){e.debug("Success Message:"+n),t.$broadcast("SuccessMessage",n)}}])}(),function(){var e=angular.module("NavigationModule");e.directive("navigationBar",["$log","$document","$sessionStorage","$location",function(e,t,n,r){return{restrict:"E",templateUrl:"./app/shared/navigation/navigation.html",replace:!0,controller:["$scope",function(t){t.logout=function(){e.debug("Logout"),delete n.userToken,r.path("/")}}]}}])}();