!function(){angular.module("AlertModule",[]),angular.module("NavigationModule",[]),angular.module("LoginModule",[]),angular.module("EventModule",[]),angular.module("TerminalModule",[]),angular.module("UserModule",[]);var e=angular.module("myAPP",["ngRoute","ngStorage","720kb.tooltips","AlertModule","LoginModule","EventModule","TerminalModule","NavigationModule","UserModule"]);e.constant("config",{getEventURL:"/events/getEvents",addEventURL:"/events/addEvent",editEventURL:"/events/editEvent",deleteEventURL:"/events/deleteEvent",getTerminalsURL:"/terminals/getTerminals",getTerminalURL:"/terminals/getTerminal",editCranesURL:"/cranes/editEventCranes",loginUserURL:"/users/login",changePasswordURL:"/users/password"}),e.constant("tableProp",{tableDayHeight:84,tableDayHeightNoBorder:83,tableTopHeaderHeight:29,tableLeftHeaderWidth:100,tableTotalWidth:1099,cellHourHeight:3.5,hoursInDay:24,minutesHour:60}),e.config(["$logProvider",function(e){e.debugEnabled(!0)}]),e.config(["$httpProvider",function(e){e.interceptors.push(["$q","$location","$log","$sessionStorage","alertService",function(e,t,n,r,a){return{request:function(e){return n.debug("Intersected"),e.headers=e.headers||{},e.headers.Accept="application/json",r.userToken&&(e.headers.Authorization="Bearer "+r.userToken),n.debug("Config Headers After:"+JSON.stringify(e.headers)),e},responseError:function(n){return 401===n.status||403===n.status?t.path("/"):n.code&&a.pushMessage(n),e.reject(n)}}}])}]),e.factory("_",[function(){return window._}]),e.config(["$routeProvider",function(e){e.when("/events/:terminalId",{templateUrl:"app/events/events.html",controller:"EventController"}).when("/terminals",{templateUrl:"app/terminals/terminals.html",controller:"TerminalController"}).when("/user",{templateUrl:"app/user/user.html",controller:"UserController"}).when("/",{templateUrl:"app/login/login.html",controller:"LoginController"}).otherwise({redirectTo:"/"})}])}(),function(){var e=angular.module("EventModule");e.controller("EventController",["$http","$log","$scope","$routeParams","config","alertService","_",function(e,t,n,r,a,o,i){function s(){e.get(a.getEventURL+"/"+v).success(function(e){t.debug("Received Events:"+JSON.stringify(e)),e.message?(t.debug("Error getting events"),o.pushMessage(e)):n.events=e}).error(function(){o.pushMessage("Connection Error")})}function u(e){for(var r=new Object,a=0,o=0;o<e.length;o++){var i=e[o];i.berthStart&&(r[i.berthId]={sumLength:a,berthName:i.berthName,berthId:i.berthId}),a+=i.berthLength}n.terminal.mainBerths=r,t.debug("Modified Terminal:"+JSON.stringify(n.terminal))}function d(e){for(var n=e.totalLength,r=999,a=0;a<e.berths.length;a++){var o=e.berths[a];o.pixelLength=r/n*o.berthLength}t.debug("New Terminal Data:"+JSON.stringify(e))}function l(){e.get(a.getTerminalURL+"/"+v).success(function(e){t.debug("Terminal Info Received:"+JSON.stringify(e)),e.type?o.pushMessage(e):(d(e),n.terminal=e,e.berths?(u(e.berths),s(),n.calendarLoaded=!0):o.pushMessage("Unable to load events"))}).error(function(){o.pushMessage("Connection Error")})}function g(){l()}var v=r.terminalId;t.debug("TERMINAL ID:"+v),n.events=[],n.terminal="",n.hours=["1","2","3","4","5","6","7","8","9","10","11","12"],n.days=[{dayId:1,dayName:"Monday"},{dayId:2,dayName:"Tuesday"},{dayId:3,dayName:"Wednesday"},{dayId:4,dayName:"Thursday"},{dayId:5,dayName:"Friday"},{dayId:6,dayName:"Saturday"},{dayId:7,dayName:"Sunday"}],n.editable=!1,n.newEvent="",n.cranesList=[],n.calendarLoaded=!1,g(),n.addNewEvent=function(r){if(t.debug("New Event"),n.eventForm.$invalid)return t.debug("Invalid Form"),void(n.eventForm.showValidation=!0);var i=angular.copy(r);t.debug("Event to Add:"+JSON.stringify(i));var s={eventName:r.eventName,eventArrivingTime:r.eventArrivingTime,eventDuration:r.eventDuration,eventStart:r.eventStart,eventLength:r.eventLength,eventDay:r.eventDay,berthId:r.berthId,terminalId:v};e.post(a.addEventURL,s).success(function(e){t.debug("Add Event Received Data:"+JSON.stringify(e)),e.message?o.pushMessage(e):(n.events.push(e),$("#eventModal").modal("hide"),n.newEvent="")}).error(function(){o.pushMessage("Connection Error")})},n.changeButton=function(){t.debug("Changing Form button"),n.editable=!1,n.eventForm.$setPristine(),n.newEvent=""},n.editEvent=function(r){if(t.debug("Edit Event"),t.debug("Edited Event:"+JSON.stringify(r)),n.eventForm.$invalid)return t.debug("Form is Invalid"),void(n.eventForm.showValidation=!0);var i={eventName:r.eventName,eventArrivingTime:r.eventArrivingTime,eventDuration:r.eventDuration,eventStart:r.eventStart,eventLength:r.eventLength,eventDay:r.eventDay,eventId:r.eventId,berthId:r.berthId,terminalId:v};e.post(a.editEventURL,i).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),s()}).error(function(){o.pushMessage("Connection Error")}),n.eventChange=n.eventChange?!1:!0,n.newEvent={}},n.editEventModal=function(e){t.debug("Edit Event Modal"),t.debug("Event to edit:"+JSON.stringify(e)),n.newEvent=angular.copy(e),n.editable=!0},n.deleteEvent=function(n){t.debug("Delete Event"),t.debug(n),e.post(a.deleteEventURL,{eventId:n.eventId}).success(function(e){t.debug("Received Delete Data:"+JSON.stringify(e)),s()}).error(function(){o.pushMessage("Connection Error")})},n.updateEvents=function(){t.debug("Update Events"),s()},n.moveEvent=function(n){t.debug("Move Event"),t.debug("Moved Event: "+JSON.stringify(n));var r={eventName:n.eventName,eventArrivingTime:n.eventArrivingTime,eventDuration:n.eventDuration,eventStart:n.eventStart,eventLength:n.eventLength,eventDay:n.eventDay,eventId:n.eventId,berthId:n.berthId};e.post(a.editEventURL,r).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e))}).error(function(){o.pushMessage("Connection Error")})},n.editCranesModal=function(e){t.debug("Edit Cranes Modal:"+JSON.stringify(e));var r=[],a=n.terminal.cranes,o=e.eventCranes;n.newEvent=e;for(var s=[],u=0;u<o.length;u++){var d=o[u];r.push(d.craneId)}t.debug("Terminal Cranes:"+JSON.stringify(a));for(var l=0;l<a.length;l++){var g=a[l],v=!1;i.contains(r,g.craneId)&&(v=!0);var c={craneId:g.craneId,craneName:g.craneName,value:v};s.push(c)}t.debug("Crane Final List:"+JSON.stringify(s)),n.cranesList=s},n.editCranes=function(r){t.debug("Edit Cranes:"+JSON.stringify(r));for(var i=n.newEvent,u={eventId:i.eventId},d=[],l=0;l<r.length;l++){var g=r[l];g.value&&d.push({craneId:g.craneId})}u.cranes=d,t.debug("JSON to Send:"+JSON.stringify(u));var v={json:JSON.stringify(u)};e.post(a.editCranesURL,v).success(function(e){t.debug("Received Edit Crane Data:"+JSON.stringify(e)),$("#craneModal").modal("hide"),s()}).error(function(){o.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("EventModule");e.directive("tableGen",function(){return{restrict:"E",templateUrl:"./app/events/table.html",replace:!0}}),e.directive("event",["$log","$document",function(e,t){return{restrict:"E",templateUrl:"./app/events/event.html",replace:!0,transclude:!0,controller:["$scope","tableProp",function(t,n){function r(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}t.eventToCSS=function(t,r){e.debug("Main Event:"+JSON.stringify(t)),e.debug("Terminal:"+JSON.stringify(r));var a=r.totalLength;t.eventStart=t.eventStart+r.mainBerths[t.berthId].sumLength,e.debug("Modified Event:"+JSON.stringify(t));var o=t.eventArrivingTime.split(":"),i=parseInt(o[0],10),s=parseInt(o[1],10),u=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*i+n.tableTopHeaderHeight,d=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*(i+t.eventDuration)+n.tableTopHeaderHeight,l=s/n.minutesHour*n.cellHourHeight;u+=l,d+=l,e.debug("arrivingTimeSec:"+s),e.debug("Add to Top:"+l);var g=t.eventStart*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,v=(t.eventStart+t.eventLength)*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,c={top:u,left:g,width:v-g,height:d-u};return c},t.CSSToEvent=function(t,a){var o=t.left,i=t.top,s=a.totalLength,u=(o-n.tableLeftHeaderWidth)*(s/(n.tableTotalWidth-n.tableLeftHeaderWidth)),d=Math.ceil((i-n.tableTopHeaderHeight)/n.tableDayHeight),l=(i-n.tableTopHeaderHeight)%n.tableDayHeight*(n.hoursInDay/n.tableDayHeightNoBorder),g=parseInt(100*(l-parseInt(l)));e.debug("Event Arriving Time:"+g);var v=g/100*n.minutesHour;e.debug("Event Arriving Minutes:"+v);var c=r(parseInt(l,10),2)+":"+r(parseInt(v,10),2),h="";for(var f in a.mainBerths){var m=a.mainBerths[f].sumLength;u>=m&&(h=f)}e.debug("Berth Id: "+h),u-=a.mainBerths[h].sumLength,e.debug("Event Start After: "+u);var p={eventStart:u,eventDay:d,eventArrivingTime:c,berthId:h};return p}}],link:function(n,r){function a(e){d=e.pageY-s,u=e.pageX-i,r.css({top:d+"px",left:u+"px"})}function o(){t.off("mousemove",a),t.off("mouseup",o);var r={left:u,top:d},i=n.CSSToEvent(r,n.terminal);n.event.eventDay=i.eventDay,n.event.eventStart=parseInt(i.eventStart),n.event.eventArrivingTime=i.eventArrivingTime,n.event.berthId=i.berthId,n.moveEvent(n.event),n.$apply(),e.debug("New scope event:"+JSON.stringify(n.event))}var i=0,s=0,u=0,d=0;n.$watch("eventChange",function(){e.debug("Event Change:"+JSON.stringify(n.event));var t=angular.copy(n.event),a=n.eventToCSS(t,n.terminal);e.debug("AFTER CSS SCOPE EVENT:"+JSON.stringify(n.event)),r.css({width:a.width,height:a.height,top:a.top,left:a.left}),i=a.left,s=a.top,u=a.left,d=a.top}),r.on("mousedown",function(e){"resizer"!=e.target.className&&(e.preventDefault(),s=e.pageY-d,i=e.pageX-u,t.on("mousemove",a),t.on("mouseup",o))})}}}]),e.directive("resizer",["$document","$log",function(e,t){return{restrict:"A",link:function(n,r){function a(e){var n=e.pageY-u+s;t.debug("New Height:"+n)}function o(){e.unbind("mousemove",a),e.unbind("mouseup",o)}var i=parseInt($(r).parent().css("top"),10),s=parseInt($(r).parent().css("height"),10),u=i+s;r.on("mousedown",function(t){t.preventDefault(),u=t.pageY-u,e.on("mousemove",a),e.on("mouseup",o)})}}}])}(),function(){var e=angular.module("LoginModule");e.controller("LoginController",["$http","$log","$scope","$routeParams","config","$rootScope","_","$location","$sessionStorage",function(e,t,n,r,a,o,i,s,u){n.loginUser="",n.showPage=!1,n.formError="",u.userToken&&""!=u.userToken?s.path("/terminals"):n.showPage=!0,n.login=function(r){t.debug("Login with:"+JSON.stringify(r));var o={userEmail:r.email,userPassword:r.password};e.post(a.loginUserURL,o).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.userToken&&""!=e.userToken?(u.userToken=e.userToken,u.userEmail=e.userEmail,s.path("/terminals")):n.formError="Invalid email or password"}).error(function(){t.debug("Error")})}}])}(),function(){var e=angular.module("TerminalModule");e.controller("TerminalController",["$http","$log","$scope","$routeParams","config","alertService",function(e,t,n,r,a,o){function i(){e.get(a.getTerminalsURL).success(function(e){t.debug("Received Terminals:"+JSON.stringify(e)),e.type?o.pushMessage(e):n.terminals=e}).error(function(){o.pushMessage("Connexion Refused")})}n.terminals=[],i()}])}(),function(){var e=angular.module("UserModule");e.controller("UserController",["$http","$log","$scope","$routeParams","config","alertService","$sessionStorage",function(e,t,n,r,a,o,i){n.newUser="",n.formError="",n.changePassword=function(r){if(t.debug("Change Password"),n.changePasswordForm.$invalid)return t.debug("Invalid Form"),void(n.changePasswordForm.showValidation=!0);if(r.newPassword!=r.confirmPassword)return void(n.formError="Confirm Password is not the same as new Password");var s={userEmail:i.userEmail,oldPassword:r.oldPassword,newPassword:r.newPassword};e.post(a.changePasswordURL,s).success(function(e){e.code?o.pushMessage(e):o.pushSuccessMessage("Password changed")}).fail(function(){o.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("AlertModule");e.directive("alertsDisplay",["$log",function(e){return{restrict:"E",templateUrl:"./app/shared/alerts/alerts.html",replace:!0,controller:["$scope",function(t){t.errorMessage="",t.showError=!1,t.showSuccess=!1,t.successMessage="",t.$on("AlertEvent",function(n,r){e.debug("AlertEvent Call:"+r),t.showError=!1,t.showError=!0,t.errorMessage=r}),t.$on("SuccessMessage",function(n,r){e.debug("Success Message Call:"+r),t.showSuccess=!0,t.successMessage=r})}]}}])}(),function(){var e=angular.module("AlertModule");e.service("alertService",["$log","$rootScope",function(e,t){this.pushMessage=function(n){e.debug("Alert Message:"+n),e.error("Error:"+JSON.stringify(n)),n.message?t.$broadcast("AlertEvent",n.message):t.$broadcast("AlertEvent",n)},this.pushSuccessMessage=function(n){e.debug("Success Message:"+n),t.$broadcast("SuccessMessage",n)}}])}(),function(){var e=angular.module("NavigationModule");e.directive("navigationBar",["$log","$document","$sessionStorage","$location",function(e,t,n,r){return{restrict:"E",templateUrl:"./app/shared/navigation/navigation.html",replace:!0,controller:["$scope",function(t){t.logout=function(){e.debug("Logout"),delete n.userToken,r.path("/")}}]}}])}();