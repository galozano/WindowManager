!function(){angular.module("AlertModule",[]),angular.module("NavigationModule",[]),angular.module("LoginModule",[]),angular.module("EventModule",[]),angular.module("TerminalModule",[]),angular.module("UserModule",[]);var e=angular.module("myAPP",["ngRoute","ngStorage","720kb.tooltips","AlertModule","LoginModule","EventModule","TerminalModule","NavigationModule","UserModule"]);e.constant("config",{getEventURL:"/events/getEvents",addEventURL:"/events/addEvent",editEventURL:"/events/editEvent",deleteEventURL:"/events/deleteEvent",getTerminalsURL:"/terminals/getTerminals",getTerminalURL:"/terminals/getTerminal",editCranesURL:"/cranes/editEventCranes",loginUserURL:"/users/login",changePasswordURL:"/users/password",getTerminalConfigSchemas:"/terminals/getTerminalConfigSchemas",createTerminalSchema:"/terminals/createTerminalSchema",getCranesSchemas:"/cranes/getCranesSchemas",createCraneSchema:"/cranes/createCraneSchema",createTerminal:"/terminals/createTerminal",deleteTerminal:"terminals/deleteTerminal"}),e.constant("errors",{connectionError:{userMessage:"Connection error, please contact Colibri support",message:"Connection error, please contact Colibri support",type:"ERROR",code:"CONNECTION_ERROR"},dataError:{userMessage:"Data error, please contact Colibri support",message:"Error on the data received by the server, it is not compatible",type:"ERROR",code:"DATA_ERROR"}}),e.constant("tableProp",{tableDayHeight:84,tableDayHeightNoBorder:83,tableTopHeaderHeight:29,tableLeftHeaderWidth:100,tableTotalWidth:1099,cellHourHeight:3.5,hoursInDay:24,minutesHour:60,totalPixelLength:999}),e.config(["$logProvider",function(e){e.debugEnabled(!0)}]),e.config(["$httpProvider",function(e){e.interceptors.push(["$q","$location","$log","$sessionStorage","alertService",function(e,t,n,r,a){return{request:function(e){return n.debug("Intersected"),e.headers=e.headers||{},e.headers.Accept="application/json",r.userToken&&(e.headers.Authorization="Bearer "+r.userToken),n.debug("Config Headers After:"+JSON.stringify(e.headers)),e},responseError:function(n){return 401===n.status||403===n.status?t.path("/"):n.code&&a.pushMessage(n),e.reject(n)}}}])}]),e.factory("_",[function(){return window._}]),e.config(["$routeProvider",function(e){e.when("/events/:terminalId",{templateUrl:"app/events/events.html",controller:"EventController"}).when("/terminals",{templateUrl:"app/terminals/terminals.html",controller:"TerminalController"}).when("/user",{templateUrl:"app/user/user.html",controller:"UserController"}).when("/",{templateUrl:"app/login/login.html",controller:"LoginController"}).otherwise({redirectTo:"/"})}])}(),function(){var e=angular.module("LoginModule");e.controller("LoginController",["$http","$log","$scope","$routeParams","config","$rootScope","_","$location","$sessionStorage",function(e,t,n,r,a,o,i,s,c){n.loginUser="",n.showPage=!1,n.formError="",c.userToken&&""!=c.userToken?s.path("/terminals"):n.showPage=!0,n.login=function(r){t.debug("Login with:"+JSON.stringify(r));var o={userEmail:r.email,userPassword:r.password};e.post(a.loginUserURL,o).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.userToken&&""!=e.userToken?(c.userToken=e.userToken,c.userEmail=e.userEmail,s.path("/terminals")):n.formError="Invalid email or password"}).error(function(){t.debug("Error")})}}])}(),function(){var e=angular.module("EventModule");e.controller("EventController",["$http","$log","$scope","$routeParams","config","alertService","_","eventService","terminalService",function(e,t,n,r,a,o,i,s,c){function u(){s.updateEvents(l).then(function(e){n.events=e},function(e){o.pushMessage(e)})}function d(){c.getTerminal(l).then(function(e){n.terminal=e,u(),n.calendarLoaded=!0},function(e){o.pushMessage(e)})}var l=r.terminalId;t.debug("TERMINAL ID:"+l),n.events=[],n.terminal="",n.hours=["1","2","3","4","5","6","7","8","9","10","11","12"],n.days=[{dayId:1,dayName:"Monday"},{dayId:2,dayName:"Tuesday"},{dayId:3,dayName:"Wednesday"},{dayId:4,dayName:"Thursday"},{dayId:5,dayName:"Friday"},{dayId:6,dayName:"Saturday"},{dayId:7,dayName:"Sunday"}],n.editable=!1,n.newEvent="",n.cranesList=[],n.calendarLoaded=!1,d(),n.addNewEvent=function(e){if(t.debug("New Event:"+JSON.stringify(e)),n.eventForm.$invalid)return t.debug("Invalid Form"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,berthId:e.berthId,terminalId:l};s.addNewEvent(r).then(function(e){n.events=e,$("#eventModal").modal("hide"),n.newEvent=""},function(e){o.pushMessage(e)})},n.changeButton=function(){t.debug("Changing Form button"),n.editable=!1,n.eventForm.$setPristine(),n.newEvent=""},n.editEvent=function(e){if(t.debug("Edit Event:"+JSON.stringify(e)),n.eventForm.$invalid)return t.debug("Form is Invalid"),void(n.eventForm.showValidation=!0);var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,eventId:e.eventId,berthId:e.berthId,terminalId:l};s.editEvent(r).then(function(e){n.events=e},function(e){o.pushMessage(e)}),n.eventChange=n.eventChange?!1:!0,n.newEvent={}},n.editEventModal=function(e){t.debug("Event to edit Modal:"+JSON.stringify(e)),n.newEvent=angular.copy(e),n.editable=!0},n.deleteEvent=function(e){t.debug("Delete Event:"+JSON.stringify(e)),s.deleteEvent(e.eventId).then(function(e){n.events=e},function(e){o.pushMessage(e)})},n.updateEvents=function(){t.debug("Update Events"),u()},n.moveEvent=function(e){t.debug("Moved Event: "+JSON.stringify(e));var r={eventName:e.eventName,eventArrivingTime:e.eventArrivingTime,eventDuration:e.eventDuration,eventStart:e.eventStart,eventLength:e.eventLength,eventDay:e.eventDay,eventId:e.eventId,berthId:e.berthId};s.editEvent(r).then(function(e){n.events=e},function(e){o.pushMessage(e)})},n.editCranesModal=function(e){t.debug("Edit Cranes Modal:"+JSON.stringify(e));var r=[],a=n.terminal.cranes,o=e.eventCranes;n.newEvent=e;for(var s=[],c=0;c<o.length;c++){var u=o[c];r.push(u.craneId)}t.debug("Terminal Cranes:"+JSON.stringify(a));for(var d=0;d<a.length;d++){var l=a[d],g=!1;i.contains(r,l.craneId)&&(g=!0);var v={craneId:l.craneId,craneName:l.craneName,value:g};s.push(v)}t.debug("Crane Final List:"+JSON.stringify(s)),n.cranesList=s},n.editCranes=function(e){t.debug("Edit Cranes:"+JSON.stringify(e));for(var r=n.newEvent,a={eventId:r.eventId},i=[],c=0;c<e.length;c++){var u=e[c];u.value&&i.push({craneId:u.craneId})}a.cranes=i,t.debug("JSON to Send:"+JSON.stringify(a)),s.editCranes(a).then(function(e){n.events=e,$("#craneModal").modal("hide")},function(e){o.pushMessage(e)})}}])}(),function(){var e=angular.module("EventModule");e.directive("tableGen",["$log",function(e){return{restrict:"E",templateUrl:"./app/events/table.html",scope:{terminal:"=terminalInfo",hours:"=hours"},controller:["$scope","tableProp",function(t,n){function r(t){if(t)for(var r=t.totalLength,a=0;a<t.berths.length;a++){var o=t.berths[a];o.pixelLength=n.totalPixelLength/r*o.berthLength}e.debug("New Terminal Data:"+JSON.stringify(t))}t.$watch("terminal",function(){console.debug("Terminal 3:"+JSON.stringify(t.terminal)),r(t.terminal)})}]}}]),e.directive("event",["$log","$document",function(e,t){return{restrict:"E",templateUrl:"./app/events/event.html",scope:{event:"=event",terminal:"=terminalInfo",eventChange:"=eventChange",moveEvent:"&moveEvent",editEventModal:"&editEventModal",deleteEvent:"&deleteEvent",editCranesModal:"&editCranesModal"},controller:["$scope","tableProp",function(t,n){function r(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}t.eventToCSS=function(t,r){e.debug("Main Event:"+JSON.stringify(t)),e.debug("Terminal:"+JSON.stringify(r));var a=r.totalLength;t.eventStart=t.eventStart+r.mainBerths[t.berthId].sumLength,e.debug("Modified Event:"+JSON.stringify(t));var o=t.eventArrivingTime.split(":"),i=parseInt(o[0],10),s=parseInt(o[1],10),c=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*i+n.tableTopHeaderHeight,u=(t.eventDay-1)*n.tableDayHeight+n.tableDayHeightNoBorder/n.hoursInDay*(i+t.eventDuration)+n.tableTopHeaderHeight,d=s/n.minutesHour*n.cellHourHeight;c+=d,u+=d,e.debug("arrivingTimeSec:"+s),e.debug("Add to Top:"+d);var l=t.eventStart*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,g=(t.eventStart+t.eventLength)*(n.tableTotalWidth-n.tableLeftHeaderWidth)/a+n.tableLeftHeaderWidth,v={top:c,left:l,width:g-l,height:u-c};return v},t.CSSToEvent=function(t,a){var o=t.left,i=t.top,s=a.totalLength,c=(o-n.tableLeftHeaderWidth)*(s/(n.tableTotalWidth-n.tableLeftHeaderWidth)),u=Math.ceil((i-n.tableTopHeaderHeight)/n.tableDayHeight),d=(i-n.tableTopHeaderHeight)%n.tableDayHeight*(n.hoursInDay/n.tableDayHeightNoBorder),l=parseInt(100*(d-parseInt(d)));e.debug("Event Arriving Time:"+l);var g=l/100*n.minutesHour;e.debug("Event Arriving Minutes:"+g);var v=r(parseInt(d,10),2)+":"+r(parseInt(g,10),2),h="";for(var m in a.mainBerths){var f=a.mainBerths[m].sumLength;c>=f&&(h=m)}e.debug("Berth Id: "+h),c-=a.mainBerths[h].sumLength,e.debug("Event Start After: "+c);var p={eventStart:c,eventDay:u,eventArrivingTime:v,berthId:h};return p}}],link:function(n,r){function a(e){u=e.pageY-s,c=e.pageX-i,r.css({top:u+"px",left:c+"px"})}function o(){t.off("mousemove",a),t.off("mouseup",o);var r={left:c,top:u},i=n.CSSToEvent(r,n.terminal);n.event.eventDay=i.eventDay,n.event.eventStart=parseInt(i.eventStart),n.event.eventArrivingTime=i.eventArrivingTime,n.event.berthId=i.berthId,n.moveEvent(n.event),n.$apply(),e.debug("New scope event:"+JSON.stringify(n.event))}var i=0,s=0,c=0,u=0;n.$watch("eventChange",function(){e.debug("Event Change:"+JSON.stringify(n.event));var t=angular.copy(n.event),a=n.eventToCSS(t,n.terminal);e.debug("AFTER CSS SCOPE EVENT:"+JSON.stringify(n.event)),r.css({width:a.width,height:a.height,top:a.top,left:a.left}),i=a.left,s=a.top,c=a.left,u=a.top}),r.on("mousedown",function(e){"resizer"!=e.target.className&&(e.preventDefault(),s=e.pageY-u,i=e.pageX-c,t.on("mousemove",a),t.on("mouseup",o))})}}}]),e.directive("resizer",["$document","$log",function(e,t){return{restrict:"A",link:function(n,r){function a(e){var n=e.pageY-c+s;t.debug("New Height:"+n)}function o(){e.unbind("mousemove",a),e.unbind("mouseup",o)}var i=parseInt($(r).parent().css("top"),10),s=parseInt($(r).parent().css("height"),10),c=i+s;r.on("mousedown",function(t){t.preventDefault(),c=t.pageY-c,e.on("mousemove",a),e.on("mouseup",o)})}}}])}(),function(){var e=angular.module("EventModule");e.service("eventService",["$http","$log","config","_","alertService","$q","errors",function(e,t,n,r,a,o,i){function s(e){c.forEach(function(t,n){t.eventId==e.eventId&&(c[n]=e)})}var c=[];this.updateEvents=function(r){var a=o.defer();return e.get(n.getEventURL+"/"+r).success(function(e){t.debug("Received Events:"+JSON.stringify(e)),e.message?(t.debug("Error getting events"),a.reject(e)):(c=e,a.resolve(c))}).error(function(){a.reject(i.connectionError)}),a.promise},this.addNewEvent=function(r){var a=o.defer(),s=angular.copy(r);return e.post(n.addEventURL,s).success(function(e){t.debug("Add Event Received Data:"+JSON.stringify(e)),e.message?a.reject(e):(c.push(e),a.resolve(c))}).error(function(){a.reject(i.connectionError)}),a.promise},this.editEvent=function(r){var a=o.defer(),u=angular.copy(r);return e.post(n.editEventURL,u).success(function(e){t.debug("Received Edit Data:"+JSON.stringify(e)),e.message?a.reject(e):(s(e),a.resolve(c))}).error(function(){a.reject(i.connectionError)}),a.promise},this.deleteEvent=function(r){var a=o.defer();return e.post(n.deleteEventURL,{eventId:r}).success(function(e){if(t.debug("Received Delete Data:"+JSON.stringify(e)),e.message)a.reject(e);else{var n=-1;c.forEach(function(e,t){e.eventId==r&&(n=t)}),c.splice(n,1),a.resolve(c)}}).error(function(){a.reject(i.connectionError)}),a.promise},this.editCranes=function(r){var a=o.defer(),u={json:JSON.stringify(r)};return e.post(n.editCranesURL,u).success(function(e){t.debug("Received Edit Crane Data:"+JSON.stringify(e)),s(e),a.resolve(c)}).error(function(){a.reject(i.connectionError)}),a.promise}}])}(),function(){var e=angular.module("TerminalModule");e.controller("TerminalController",["$http","$log","$scope","$routeParams","config","alertService","terminalService","_",function(e,t,n,r,a,o,i){function s(){i.getTerminals().then(function(e){n.terminals=e},function(e){o.pushMessage(e)}),i.getTerminalSchemas().then(function(e){n.berthSchemas=e},function(e){o.pushMessage(e)}),i.getCranesSchemasConfigs().then(function(e){n.cranesSchemas=e},function(e){o.pushMessage(e)})}n.terminals=[],n.berthSchemas=[],n.cranesSchemas=[],n.newBerthSchema={},n.newCraneSchema={},n.viewMode=!1,s(),n.addNewBerth=function(e){if(e&&!n.berthForm.$invalid){n.newBerthSchema.berths||(n.newBerthSchema.berths=[]),e.berthStart||(e.berthStart=!1),0==n.newBerthSchema.berths.length&&(e.berthStart=!0);var r=angular.copy(e);r.berthSequence=n.newBerthSchema.berths.length+1,t.debug("New Berth Add:"+JSON.stringify(r)),n.newBerthSchema.berths.push(r),n.newBerth={}}},n.deleteBerth=function c(c){var e=-1;n.newBerthSchema.berths.forEach(function(t,n){t===c&&(e=n)}),n.newBerthSchema.berths.splice(e,1),n.newBerthSchema.berths.length>=1&&(n.newBerthSchema.berths[0].berthStart=!0)},n.createNewBerthSchema=function(e){t.debug("New Berth Schema to Add:"+angular.toJson(e)),e&&""!=e.terminalConfigSchemaName&&e.berths&&e.berths.length>0&&i.createTerminalSchema(e).then(function(e){t.debug("Berth Schema added:"+JSON.stringify(e)),n.berthSchemas=e,$("#berthModal").modal("hide"),n.newBerthSchema={}},function(e){o.pushMessage(e)})},n.addNewCrane=function(e){if(t.debug("New crane:"+JSON.stringify(e)),e){n.newCraneSchema.cranes||(n.newCraneSchema.cranes=[]);{angular.copy(e)}n.newCraneSchema.cranes.push(e),n.newCrane={}}},n.deleteCrane=function u(u){var e=-1;n.newCraneSchema.cranes.forEach(function(t,n){t===u&&(e=n)}),n.newCraneSchema.cranes.splice(e,1)},n.createCraneSchema=function(e){t.debug("New Crane Schema to Add:"+JSON.stringify(e)),e&&""!=e.craneConfigSchemaName&&e.cranes&&e.cranes.length>0&&(t.debug("NewCraneSchema OK and craneform OK"),i.createCraneSchema(e).then(function(e){n.newCraneSchema={},n.cranesSchemas=e,$("#craneModal").modal("hide")},function(e){o.pushMessage(e)}))},n.createTerminal=function(e){t.debug("create new terminal:"+JSON.stringify(e)),e&&i.createTerminal(e).then(function(e){n.terminals=e,n.newTerminal={},$("#terminalModal").modal("hide")},function(e){o.pushMessage(e)})},n.changeToEditMode=function(){n.newBerthSchema={},n.newCraneSchema={},n.viewMode=!1},n.viewBerthSchema=function(e){n.viewMode=!0,n.berthSchemas.forEach(function(t){t===e&&(n.newBerthSchema=t)})},n.viewCraneSchema=function(e){n.viewMode=!0,n.cranesSchemas.forEach(function(t){t===e&&(n.newCraneSchema=t)})},n.deleteTerminal=function(e){e&&i.deleteTerminal(e).then(function(e){n.terminals=e},function(e){o.pushMessage(e)})}}])}(),function(){var e=angular.module("TerminalModule");e.service("terminalService",["$http","$log","config","_","alertService","$q","errors",function(e,t,n,r,a,o,i){function s(e){for(var t={},n=0,r=0;r<e.length;r++){var a=e[r];a.berthStart&&(t[a.berthId]={sumLength:n,berthName:a.berthName,berthId:a.berthId}),n+=a.berthLength}return t}var c={},u=[],d=[],l=[];this.getTerminal=function(r){var a=o.defer();return e.get(n.getTerminalURL+"/"+r).success(function(e){t.debug("Terminal Info Received:"+JSON.stringify(e)),e.type?a.reject(e):(c=e,e.berths?(c.mainBerths=s(c.berths),a.resolve(c)):a.reject(i.connectionError))}).error(function(){a.reject(i.connectionError)}),a.promise},this.getTerminals=function(){var r=o.defer();return e.get(n.getTerminalsURL).success(function(e){t.debug("Received Terminals:"+JSON.stringify(e)),e.type?r.reject(e):(u=e,r.resolve(u))}).error(function(){r.reject(i.connectionError)}),r.promise},this.getTerminalSchemas=function(){var r=o.defer();return e.get(n.getTerminalConfigSchemas).success(function(e){t.debug("Schema Info Received:"+JSON.stringify(e)),"OK"==e.status&&e.data?(d=e.data,r.resolve(d)):r.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){r.reject(i.connectionError)}),r.promise},this.createTerminalSchema=function(r){var a=o.defer(),s={data:angular.toJson(r)};return e.post(n.createTerminalSchema,s).success(function(e){if(t.debug("Schema Info Received:"+JSON.stringify(e)),"OK"==e.status&&e.data){t.debug("Data OK");var n=e.data;d.push(n),a.resolve(d)}else a.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){a.reject(i.connectionError)}),a.promise},this.getCranesSchemasConfigs=function(){var r=o.defer();return e.get(n.getCranesSchemas).success(function(e){t.debug("Schema Info Received:"+JSON.stringify(e)),"OK"==e.status&&e.data?(l=e.data,r.resolve(l)):r.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){r.reject(i.connectionError)}),r.promise},this.createCraneSchema=function(r){t.debug("New Crane Schema Terminal Service:"+JSON.stringify(r));var a=o.defer(),s={data:angular.toJson(r)};return e.post(n.createCraneSchema,s).success(function(e){if(t.debug("Schema Info Received:"+JSON.stringify(e)),"OK"==e.status&&e.data){t.debug("Data OK");var n=e.data;l.push(n),a.resolve(l)}else a.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){a.reject(i.connectionError)}),a.promise},this.createTerminal=function(r){t.debug("Create Terminal Service:"+JSON.stringify(r));var a=o.defer(),s={data:angular.toJson(r)};return e.post(n.createTerminal,s).success(function(e){if("OK"==e.status&&e.data){t.debug("Data OK");var n=e.data,r={terminalId:n.terminalId,terminalName:n.terminalName};u.push(r),a.resolve(u)}else a.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){a.reject(i.connectionError)}),a.promise},this.deleteTerminal=function(r){t.debug("Delete Terminal:"+JSON.stringify(r));var a=o.defer(),s={data:JSON.stringify({terminalId:r.terminalId})};return e.post(n.deleteTerminal,s).success(function(e){if("OK"==e.status&&e.data){var t=-1;u.forEach(function(e,n){e==r&&(t=n)}),u.splice(t,1),a.resolve(u)}else a.reject("ERROR"==e.status?e.data:i.dataError)}).error(function(){a.reject(i.connectionError)}),a.promise}}])}(),function(){var e=angular.module("UserModule");e.controller("UserController",["$http","$log","$scope","$routeParams","config","alertService","$sessionStorage",function(e,t,n,r,a,o,i){n.newUser="",n.formError="",n.changePassword=function(r){if(t.debug("Change Password"),n.changePasswordForm.$invalid)return t.debug("Invalid Form"),void(n.changePasswordForm.showValidation=!0);if(r.newPassword!=r.confirmPassword)return void(n.formError="Confirm Password is not the same as new Password");var s={userEmail:i.userEmail,oldPassword:r.oldPassword,newPassword:r.newPassword};e.post(a.changePasswordURL,s).success(function(e){e.code?o.pushMessage(e):o.pushSuccessMessage("Password changed")}).fail(function(){o.pushMessage("Connection Error")})}}])}(),function(){var e=angular.module("AlertModule");e.directive("alertsDisplay",["$log",function(e){return{restrict:"E",templateUrl:"./app/shared/alerts/alerts.html",replace:!0,controller:["$scope",function(t){t.errorMessage="",t.showError=!1,t.showSuccess=!1,t.successMessage="",t.$on("AlertEvent",function(n,r){e.debug("AlertEvent Call:"+JSON.stringify(r)),t.showError=!1,t.showError=!0,t.errorMessage=r}),t.$on("SuccessMessage",function(n,r){e.debug("Success Message Call:"+JSON.stringify(r)),t.showSuccess=!0,t.successMessage=r})}]}}])}(),function(){var e=angular.module("AlertModule");e.service("alertService",["$log","$rootScope",function(e,t){this.pushMessage=function(n){e.debug("Alert Message:"+JSON.stringify(n)),e.error("Error:"+JSON.stringify(n)),n.message?t.$broadcast("AlertEvent",n.message):t.$broadcast("AlertEvent",n)},this.pushSuccessMessage=function(n){e.debug("Success Message:"+JSON.stringify(n)),t.$broadcast("SuccessMessage",n)}}])}(),function(){var e=angular.module("NavigationModule");e.directive("navigationBar",["$log","$document","$sessionStorage","$location",function(e,t,n,r){return{restrict:"E",templateUrl:"./app/shared/navigation/navigation.html",replace:!0,controller:["$scope",function(t){t.logout=function(){e.debug("Logout"),delete n.userToken,r.path("/")}}]}}])}();